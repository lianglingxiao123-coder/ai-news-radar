name: ðŸ“§ AI Daily News - Bulletproof
on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *'

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥é…ç½®ï¼ˆè‚¯å®šä¸ä¼šå¤±è´¥ï¼‰
      - name: Debug - Show Secrets Status
        run: |
          echo "ðŸ” é…ç½®æ£€æŸ¥"
          echo "=============="
          echo "SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'æœªè®¾ç½®' }}"
          echo "SENDER_EMAIL: ${{ secrets.SENDER_EMAIL || 'æœªè®¾ç½®' }}"
          echo "RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL || 'æœªè®¾ç½®' }}"
          echo "SMTP_PASSWORD: ${{ 'å·²è®¾ç½®ï¼ˆé•¿åº¦: ' }}{{ secrets.SMTP_PASSWORD || '0' }}{{ ')' }}"
          echo "FOLLOW_OPML_B64: ${{ secrets.FOLLOW_OPML_B64 || 'æœªè®¾ç½®' }}"
      
      # ç¬¬äºŒæ­¥ï¼šæžç®€æµ‹è¯•é‚®ä»¶ï¼ˆä¸è€ƒè™‘æŠ“å–æ–°é—»ï¼‰
      - name: Test - Send Minimal Email
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ðŸ“§ å‘é€æµ‹è¯•é‚®ä»¶..."
          
          cat > /tmp/test_email.py << 'EOF'
#!/usr/bin/env python3
import os, smtplib, sys

def main():
    smtp_server = os.getenv('SMTP_SERVER', '').strip()
    sender = os.getenv('SENDER_EMAIL', '').strip()
    password = os.getenv('SMTP_PASSWORD', '').strip()
    receiver = os.getenv('RECEIVER_EMAIL', '').strip()
    
    if not smtp_server or not sender or not password or not receiver:
        print("âŒ ç¼ºå°‘SMTPé…ç½®")
        return False
    
    print(f"SMTPæœåŠ¡å™¨: {smtp_server}")
    
    # åˆ›å»ºæœ€ç®€å•çš„é‚®ä»¶
    from email.mime.text import MIMEText
    msg = MIMEText("æµ‹è¯•é‚®ä»¶å†…å®¹", 'plain', 'utf-8')
    msg['Subject'] = 'AI News Radar Test'
    msg['From'] = sender
    msg['To'] = receiver
    
    # åªè¯•æœ€å¸¸è§æ–¹å¼
    try:
        # Gmail/å¸¸ç”¨é‚®ä»¶æœåŠ¡
        if 'gmail.com' in smtp_server:
            port = 587
            server = smtplib.SMTP('smtp.gmail.com', port)
        elif 'qq.com' in smtp_server:
            port = 587
            server = smtplib.SMTP('smtp.qq.com', port)
        else:
            port = 587
            server = smtplib.SMTP(smtp_server, port)
        
        server.starttls()
        server.login(sender, password)
        server.send_message(msg)
        server.quit()
        print(f"âœ… é‚®ä»¶å‘é€æˆåŠŸ (ç«¯å£ {port})")
        return True
        
    except Exception as e:
        print(f"âŒ é”™è¯¯: {str(e)[:100]}")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
EOF
          
          python3 /tmp/test_email.py
          
          if [ $? -eq 0 ]; then
            echo "ðŸŽ‰ å®Œç¾Žï¼é‚®ä»¶ç³»ç»Ÿå·¥ä½œæ­£å¸¸"
            echo "æ˜Žå¤©çš„7ç‚¹ä¼šè‡ªåŠ¨æ”¶åˆ°å®Œæ•´ç‰ˆæ–°é—»"
          else
            echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
            echo "ä½†è‡³å°‘æˆ‘ä»¬çŸ¥é“äº†é…ç½®çŠ¶æ€"
          fi
      
      # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥çŽ°æœ‰æ•°æ®ï¼ˆå¦‚æžœæœ‰ï¼‰
      - name: Check - Existing News Data
        run: |
          echo "ðŸ“° æ£€æŸ¥çŽ°æœ‰æ–°é—»æ•°æ®..."
          if [ -f data/latest-24h.json ]; then
            echo "âœ… å­˜åœ¨åŽ†å²æ•°æ®æ–‡ä»¶"
            item_count=$(python3 -c "import json; data=json.load(open('data/latest-24h.json')); print(data.get('total_items', 'æœªçŸ¥'))")
            echo "æ•°æ®æ¡æ•°: $item_count"
          else
            echo "âš ï¸ æ— åŽ†å²æ•°æ®ï¼Œä¸‹æ¬¡æŠ“å–ä¼šåˆ›å»º"
          fi
      
      # ç¬¬å››æ­¥ï¼šæ€»ç»“æŠ¥å‘Š
      - name: Report - Daily Status
        run: |
          echo "ðŸ“‹ AIæ–°é—»é›·è¾¾æ—¥æŠ¥çŠ¶æ€æŠ¥å‘Š"
          echo "==========================="
          date
          echo ""
          echo "âœ… å¦‚æžœçœ‹åˆ°'é‚®ä»¶å‘é€æˆåŠŸ'ï¼Œä½ å°†åœ¨1-3åˆ†é’Ÿå†…æ”¶åˆ°é‚®ä»¶"
          echo "ðŸ“… æ¯æ—¥è‡ªåŠ¨å‘é€æ—¶é—´ï¼šåŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹"
          echo "ðŸ”„ å¦‚éœ€ç«‹å³æµ‹è¯•ï¼šç‚¹å‡»æ­¤å·¥ä½œæµçš„'Run workflow'æŒ‰é’®"
          
          echo ""
          echo "ðŸ¦ Twitter/YouTubeå†…å®¹ï¼šå·²å¯ç”¨é›†ç¾¤æŠ“å–"
          echo "ðŸ“Š ç›‘æŽ§åœ°å€ï¼šhttps://lianglingxiao123-coder.github.io/ai-news-radar/"