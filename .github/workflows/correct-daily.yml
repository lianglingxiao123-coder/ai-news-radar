name: Daily AI News Email
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Test SMTP briefly
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          # Use heredoc for proper syntax
          python3 << 'EOF'
import os, smtplib, sys
from email.mime.text import MIMEText

smtp_server = os.getenv('SMTP_SERVER')
sender = os.getenv('SENDER_EMAIL')
password = os.getenv('SMTP_PASSWORD')
receiver = os.getenv('RECEIVER_EMAIL')

# Simple email content
content = "AI News Radar: Test email from GitHub Actions"
msg = MIMEText(content, 'plain', 'utf-8')
msg['Subject'] = "SMTP Test Success"
msg['From'] = sender
msg['To'] = receiver

try:
    # Try standard SMTP with STARTTLS
    server = smtplib.SMTP(smtp_server, 587)
    server.starttls()
    server.login(sender, password)
    server.send_message(msg)
    server.quit()
    print("âœ… Email sent successfully!")
    sys.exit(0)
except Exception as e:
    print(f"SMTP failed: {e}")
    sys.exit(1)
EOF
          
          if [ $? -eq 0 ]; then
            echo "ðŸŽ‰ Email system is working!"
          else
            echo "âš ï¸ Email test failed. Check SMTP configuration."
          fi