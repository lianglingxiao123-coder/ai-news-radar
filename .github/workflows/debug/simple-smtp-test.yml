name: Simple SMTP Test
on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Test SMTP connection
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          echo "ðŸš€ å¼€å§‹SMTPæµ‹è¯•..."
          
          python3 << 'EOF'
import os, smtplib, ssl, sys

# èŽ·å–é…ç½®
smtp_server = os.getenv('SMTP_SERVER')
sender_email = os.getenv('SENDER_EMAIL')
password = os.getenv('SMTP_PASSWORD')
receiver_email = os.getenv('RECEIVER_EMAIL')

print("=== SMTP é…ç½®æ£€æŸ¥ ===")
print(f"Server: {smtp_server}")
print(f"Sender: {sender_email}")
print(f"Receiver: {receiver_email}")
print(f"Password length: {len(password) if password else 0}")

if not all([smtp_server, sender_email, password, receiver_email]):
    print("âŒ ç¼ºå°‘å¿…è¦é…ç½®")
    sys.exit(1)

# æµ‹è¯•è¿žæŽ¥æ€§
print("\n=== è¿žæŽ¥æµ‹è¯• ===")

# å¸¸è§ç«¯å£æµ‹è¯•
ports_to_test = [587, 465, 25, 2525]

for port in ports_to_test:
    try:
        print(f"Testing port {port}...")
        
        if port == 465:  # SSL
            context = ssl.create_default_context()
            server = smtplib.SMTP_SSL(smtp_server, port, context=context, timeout=10)
            server.noop()
            server.quit()
            print(f"âœ… Port {port} (SSL) - è¿žæŽ¥æˆåŠŸ")
        else:  # æ™®é€šæˆ–STARTTLS
            server = smtplib.SMTP(smtp_server, port, timeout=10)
            server.ehlo()
            
            if port == 587 or port == 2525:  # é€šå¸¸å¯ç”¨STARTTLS
                try:
                    server.starttls()
                    server.ehlo()
                except:
                    pass
            
            server.noop()
            server.quit()
            print(f"âœ… Port {port} - è¿žæŽ¥æˆåŠŸ")
            
    except Exception as e:
        error_msg = str(e)
        if "connection refused" in error_msg.lower():
            print(f"âš ï¸ Port {port} - è¿žæŽ¥è¢«æ‹’ç»")
        elif "timed out" in error_msg.lower():
            print(f"âš ï¸ Port {port} - è¿žæŽ¥è¶…æ—¶")
        else:
            print(f"âš ï¸ Port {port} - é”™è¯¯: {error_msg[:60]}")

print("\n=== å‘é€æµ‹è¯•é‚®ä»¶ ===")

from email.mime.text import MIMEText
msg = MIMEText("è¿™æ˜¯ä¸€å°æ¥è‡ªAI News Radarçš„æµ‹è¯•é‚®ä»¶", 'plain', 'utf-8')
msg['Subject'] = 'AI News Radar æµ‹è¯•é‚®ä»¶'
msg['From'] = sender_email
msg['To'] = receiver_email

try:
    # å…ˆè¯•STARTTLS
    server = smtplib.SMTP(smtp_server, 587)
    server.ehlo()
    server.starttls()
    server.ehlo()
    server.login(sender_email, password)
    server.send_message(msg)
    server.quit()
    print("ðŸŽ‰ é‚®ä»¶å‘é€æˆåŠŸ (STARTTLS+587)")
    sys.exit(0)
except Exception as e1:
    print(f"STARTTLSå¤±è´¥: {str(e1)[:80]}")
    
    try:
        # å†è¯•SSL
        context = ssl.create_default_context()
        server = smtplib.SMTP_SSL(smtp_server, 465, context=context)
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        print("ðŸŽ‰ é‚®ä»¶å‘é€æˆåŠŸ (SSL+465)")
        sys.exit(0)
    except Exception as e2:
        print(f"SSLå¤±è´¥: {str(e2)[:80]}")
        print("\nâŒ æ‰€æœ‰å‘é€æ–¹å¼å¤±è´¥")
        sys.exit(1)
EOF