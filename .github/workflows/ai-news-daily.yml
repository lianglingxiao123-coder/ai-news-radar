name: AI News Daily Email
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'  # UTC 23:30ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:30

jobs:
  daily-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # æµ‹è¯•SMTPè¿æ¥çš„ç®€å•ç‰ˆæœ¬
      - name: Quick SMTP Test
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ§ª ç¬¬ä¸€æ­¥ï¼šSMTPè¿æ¥æµ‹è¯•"
          
          python3 -c "
import os, smtplib, sys
smtp_server = os.getenv('SMTP_SERVER')
sender = os.getenv('SENDER_EMAIL')
password = os.getenv('SMTP_PASSWORD')

print(f'æœåŠ¡å™¨: {smtp_server}')
print(f'å‘ä»¶ç®±: {sender}')
print(f'å¯†ç æ£€æŸ¥: {len(password) if password else 0} chars')

if not all([smtp_server, sender, password]):
    print('âŒ ç¼ºå°‘å¿…è¦é…ç½®')
    sys.exit(1)

try:
    # å¿«é€Ÿè¿æ¥æµ‹è¯•
    server = smtplib.SMTP(smtp_server, 587, timeout=5)
    server.ehlo()
    print('âœ… SMTPæœåŠ¡å™¨å¯è¾¾')
    server.quit()
except Exception as e:
    print(f'âš ï¸ SMTPæµ‹è¯•: {str(e)[:50]}')
          "
      
      - name: æŠ“å–æ–°é—»
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          echo "ğŸ“° ç¬¬äºŒæ­¥ï¼šæŠ“å–æ–°é—»"
          
          # åŠ è½½OPML
          if [ -n "$OPML_B64" ]; then
            echo "$OPML_B64" | base64 --decode > feeds/follow.opml 2>/dev/null || echo "OPMLåŠ è½½å¤±è´¥"
          fi
          
          # ä½¿ç”¨ç®€åŒ–æŠ“å–
          python scripts/update_news.py --output-dir data --window-hours 24 --timeout 60 || echo "æŠ“å–å¯èƒ½å¤±è´¥"
      
      - name: å‘é€é‚®ä»¶ï¼ˆç¡®ä¿å·¥ä½œï¼‰
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ“§ ç¬¬ä¸‰æ­¥ï¼šå‘é€é‚®ä»¶"
          
          # åˆ›å»ºæœ€ç®€å•çš„é‚®ä»¶å‘é€è„šæœ¬
          python3 << 'EOF'
import os, smtplib, ssl, sys
from email.mime.text import MIMEText

smtp_server = os.getenv('SMTP_SERVER')
sender = os.getenv('SENDER_EMAIL')
password = os.getenv('SMTP_PASSWORD')
receiver = os.getenv('RECEIVER_EMAIL')

print(f"å‘é€é‚®ä»¶åˆ°: {receiver}")

# åˆ›å»ºæåº¦ç®€å•çš„é‚®ä»¶
content = """
<html>
<body>
<h2>ğŸ¤– AIæ–°é—»é›·è¾¾æµ‹è¯•é‚®ä»¶</h2>
<p>å¦‚æœä½ æ”¶åˆ°è¿™å°é‚®ä»¶ï¼Œè¯´æ˜SMTPé…ç½®å·¥ä½œæ­£å¸¸ï¼</p>
<p>ç³»ç»Ÿå°†åœ¨æ¯å¤©æ—©ä¸Š7:30è‡ªåŠ¨å‘é€æœ€æ–°AIæ–°é—»ç»™ä½ ã€‚</p>
</body>
</html>
"""

msg = MIMEText(content, 'html', 'utf-8')
msg['Subject'] = 'âœ… AIæ–°é—»é›·è¾¾ï¼šæµ‹è¯•é‚®ä»¶'
msg['From'] = sender
msg['To'] = receiver

methods = [
    (587, 'STARTTLS'),
    (465, 'SSL'),
    (25, 'Plain'),
]

for port, method in methods:
    try:
        print(f"\nå°è¯• {method} (ç«¯å£ {port})...")
        if method == 'SSL':
            context = ssl.create_default_context()
            server = smtplib.SMTP_SSL(smtp_server, port, context=context)
        else:
            server = smtplib.SMTP(smtp_server, port)
            if method == 'STARTTLS':
                server.starttls()
        
        server.login(sender, password)
        server.send_message(msg)
        server.quit()
        
        print(f"ğŸ‰ {method} æˆåŠŸï¼é‚®ä»¶å·²å‘é€")
        print("è¯·æ£€æŸ¥ä½ çš„æ”¶ä»¶ç®±å’Œåƒåœ¾ç®±")
        sys.exit(0)
        
    except Exception as e:
        print(f"âŒ {method} å¤±è´¥: {str(e)[:50]}")

print("\nğŸ’¥ æ‰€æœ‰æ–¹å¼å‡å¤±è´¥")
print("è¯·æ£€æŸ¥SMTPé…ç½®")
sys.exit(1)
EOF
          
          # æ£€æŸ¥ç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ…âœ…âœ… é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥ä½ çš„é‚®ç®±ã€‚"
          else
            echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
            echo "ä½†æ˜¯æˆ‘ä»¬å·²ç»ç¡®å®šäº†SMTPé…ç½®æ˜¯å¦æ­£ç¡®"
          fi