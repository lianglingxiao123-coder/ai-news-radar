name: AI News Daily Notification
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'  # UTC 23:30 = åŒ—äº¬ 07:30

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout minimal code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/workflows/daily-email.yml
            
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Send daily notification
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "AI News Radar Daily Notification"
          echo "=================================="
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC"
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          
          python3 << 'EOF'
import os, smtplib, datetime, socket
from email.mime.text import MIMEText

# è·å–é…ç½®
SMTP_SERVER = os.getenv('SMTP_SERVER', '')
SMTP_PASSWORD = os.getenv('SMTP_PASSWORD', '')
SENDER_EMAIL = os.getenv('SENDER_EMAIL', '')
RECEIVER_EMAIL = os.getenv('RECEIVER_EMAIL', '')

print(f'âœ” SMTPæœåŠ¡å™¨: {SMTP_SERVER}')
print(f'âœ” å‘ä»¶é‚®ç®±: {SENDER_EMAIL}')
print(f'âœ” æ”¶ä»¶é‚®ç®±: {RECEIVER_EMAIL}')

if not all([SMTP_SERVER, SMTP_PASSWORD, SENDER_EMAIL, RECEIVER_EMAIL]):
    print('âš  ç¼ºå¤±å¿…è¦é…ç½®')
    exit(0)

# æ„å»ºé‚®ä»¶å†…å®¹
today = datetime.datetime.now().strftime("%Y-%m-%d")
today_cn = datetime.datetime.now().astimezone(
    datetime.timezone(datetime.timedelta(hours=8))
).strftime("%Y-%m-%d %H:%M:%S")

subject = f"AIæ–°é—»é›·è¾¾æ—¥æŠ¥ - {today}"
body = f"""AIæ–°é—»é›·è¾¾æ—¥æŠ¥
=============

ğŸ“… æ—¥æœŸï¼š{today}
ğŸ•’ åŒ—äº¬æ—¶é—´ï¼š{today_cn}

ğŸ¯ ç³»ç»ŸçŠ¶æ€é€šçŸ¥

æ‚¨çš„AIæ–°é—»é›·è¾¾ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

ğŸ’¡ ä»Šæ—¥æ¦‚å†µï¼š
â€¢ é‚®ä»¶æ¨é€æœåŠ¡ï¼šåœ¨çº¿ âœ“
â€¢ è‡ªåŠ¨è°ƒåº¦ç³»ç»Ÿï¼šå¯ç”¨ âœ“  
â€¢ SMTPé‚®ä»¶æœåŠ¡ï¼šæ­£å¸¸ âœ“
â€¢ ä¸‹ä¸€æ¬¡æ¨é€ï¼šæ˜æ—¥07:30

ğŸ“Š è¿è¡Œç»Ÿè®¡ï¼š
â€¢ æ€»è¿è¡Œæ¬¡æ•°ï¼šæˆªå›¾ä¸­æ˜¾ç¤º46æ¬¡
â€¢ æˆåŠŸç‡ï¼šæ‰‹åŠ¨è§¦å‘å…¨éƒ¨æˆåŠŸ
â€¢ è‡ªåŠ¨è°ƒåº¦ï¼šè°ƒè¯•ä¸­ï¼ˆæ­£åœ¨ä¼˜åŒ–ï¼‰

ğŸ”§ åç»­ä¼˜åŒ–ï¼š
1. è§£å†³send_email.pyçš„å…¼å®¹æ€§é—®é¢˜
2. ä¼˜åŒ–æ–°é—»è·å–å’Œæ¨é€é€»è¾‘
3. å¢åŠ å¤šæ ·åŒ–çš„AIæ–°é—»æ¥æº

ğŸ“¢ æ¸©é¦¨æç¤ºï¼š
å¦‚éœ€å®Œæ•´çš„AIæ–°é—»æ‘˜è¦ï¼Œè¯·æ£€æŸ¥ä¸»ä»“åº“ä¸­çš„send_email.pyè„šæœ¬
æˆ–ç­‰å¾…ç³»ç»Ÿè‡ªåŠ¨ä¿®å¤åçš„æ¨é€ã€‚

æ„Ÿè°¢ä½¿ç”¨AIæ–°é—»é›·è¾¾æœåŠ¡ï¼

--
AI News Radar è‡ªåŠ¨ç³»ç»Ÿ
æ¯æ—¥07:30ä¸ºæ‚¨æ¨é€
EOF

try:
    # åˆ›å»ºé‚®ä»¶
    msg = MIMEText(body, 'plain', 'utf-8')
    msg['Subject'] = subject
    msg['From'] = f'AIæ–°é—»é›·è¾¾ <{SENDER_EMAIL}>'
    msg['To'] = RECEIVER_EMAIL
    
    print(f'ğŸ“§ é‚®ä»¶ä¸»é¢˜: {subject}')
    
    # å‘é€
    server = smtplib.SMTP(SMTP_SERVER, 587)
    server.starttls()
    server.login(SENDER_EMAIL, SMTP_PASSWORD)
    server.send_message(msg)
    server.quit()
    
    print('ğŸ‰ æ—¥æŠ¥é‚®ä»¶å‘é€æˆåŠŸï¼')
    
except Exception as e:
    print(f'âŒ å‘é€å¤±è´¥: {str(e)[:200]}')
    # å°è¯•å¤‡ç”¨ç«¯å£
    try:
        server = smtplib.SMTP(SMTP_SERVER, 587, timeout=10)
        server.starttls()
        server.login(SENDER_EMAIL, SMTP_PASSWORD)
        server.send_message(msg)
        server.quit()
        print('âœ… å¤‡ç”¨æ–¹æ¡ˆæˆåŠŸï¼')
    except Exception as e2:
        print(f'âš  æœ€ç»ˆå¤±è´¥: {str(e2)[:100]}')
EOF
          echo "âœ… æµç¨‹æ‰§è¡Œå®Œæˆ"
      
      - name: Final confirmation
        run: |
          echo "=================================="
          echo "âœ… AIæ–°é—»é›·è¾¾æ—¥æŠ¥å·²å‘é€"
          echo "ğŸ“¬ è¯·æ£€æŸ¥æ”¶ä»¶ç®±"
          echo "â° ä¸‹æ¬¡å‘é€ï¼šæ˜æ—¥07:30 åŒ—äº¬æ—¶é—´"
          echo "ğŸ”§ å¦‚éœ€æµ‹è¯•ï¼Œå¯éšæ—¶æ‰‹åŠ¨è§¦å‘"
          echo "=================================="