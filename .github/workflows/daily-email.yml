name: Daily AI News Email
on:
  workflow_dispatch: {}
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Send email
        env:
          SERVER: ${{ secrets.SMTP_SERVER }}
          PASS: ${{ secrets.SMTP_PASSWORD }}
          FROM: ${{ secrets.SENDER_EMAIL }}
          TO: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "Testing email configuration..."
          
          # 创建测试文件
          cat > test_email.py << 'EOF_INNER'
import os, smtplib
from email.mime.text import MIMEText

srv = os.environ.get('SERVER')
frm = os.environ.get('FROM')
pwd = os.environ.get('PASS')
to = os.environ.get('TO')

print("Config:")
print(f"  Server: {srv}")
print(f"  From: {frm}")
print(f"  To: {to}")

if not all([srv, frm, pwd, to]):
    print("Configuration incomplete")
    exit(0)

msg = MIMEText("AI News Radar test email", 'plain', 'utf-8')
msg['Subject'] = 'Test from AI News Radar'
msg['From'] = frm
msg['To'] = to

try:
    conn = smtplib.SMTP(srv, 587)
    conn.starttls()
    conn.login(frm, pwd)
    conn.send_message(msg)
    conn.quit()
    print("Email sent")
    exit(0)
except Exception as e:
    print(f"Error: {e}")
    exit(1)
EOF_INNER
          
          python3 test_email.py