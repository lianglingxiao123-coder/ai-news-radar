name: Daily Email Push
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:00
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘ - è¿™è¡Œå¾ˆé‡è¦ï¼
    inputs:
      force:
        description: 'å¼ºåˆ¶é‡æ–°æŠ“å–'
        required: false
        default: 'false'

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Load OPML configuration
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          if [ -n "$OPML_B64" ]; then
            mkdir -p feeds
            base64 --decode <<< "$OPML_B64" > feeds/follow.opml 2>/dev/null || echo "Base64è§£ç å¤±è´¥"
          fi
      
      - name: Fetch latest news (optimized)
        run: |
          echo "å¼€å§‹æŠ“å–æœ€æ–°æ–°é—»..."
          if [ -f feeds/follow.opml ]; then
            python scripts/update_news.py --output-dir data --window-hours 24 --rss-opml feeds/follow.opml --timeout 120
          else
            python scripts/update_news.py --output-dir data --window-hours 24 --timeout 120
          fi
          echo "æŠ“å–å®Œæˆ"
      
      - name: å‘é€é‚®ä»¶ï¼ˆè¶…ç®€åŒ–ç‰ˆæœ¬ï¼‰(Super Simple Version)
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸš€ å‘é€æµ‹è¯•é‚®ä»¶..."
          
          # åˆ›å»ºæœ€ç®€å•çš„Pythonè„šæœ¬
          python3 << 'EOF'
import os, smtplib, json, sys
from email.mime.text import MIMEText

# è·å–é…ç½®
smtp_server = os.getenv('SMTP_SERVER')
sender_email = os.getenv('SENDER_EMAIL')
password = os.getenv('SMTP_PASSWORD')
receiver_email = os.getenv('RECEIVER_EMAIL')

print(f"ä½¿ç”¨SMTPæœåŠ¡å™¨: {smtp_server}")
print(f"å‘ä»¶äºº: {sender_email}")
print(f"æ”¶ä»¶äºº: {receiver_email}")
print(f"å¯†ç é•¿åº¦: {len(password) if password else 0}")

# åˆ›å»ºé‚®ä»¶å†…å®¹
content = """<h2>ğŸ¤– AIæ–°é—»é›·è¾¾æµ‹è¯•é‚®ä»¶</h2>
<p>è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶ï¼Œç¡®è®¤ä½ çš„é‚®ä»¶é…ç½®æ­£å¸¸å·¥ä½œï¼</p>
<p>ç°åœ¨å¼€å§‹ï¼Œä½ å°†åœ¨æ¯å¤©æ—©ä¸Š7ç‚¹æ”¶åˆ°AIè¡Œä¸šçš„æœ€æ–°åŠ¨æ€ã€‚</p>
<hr>
<p><small>æ—¶é—´æˆ³: åœ¨GitHub Actionsä¸­ç”Ÿæˆ</small></p>
"""

msg = MIMEText(content, 'html', 'utf-8')
msg['Subject'] = 'âœ… AIæ–°é—»é›·è¾¾: é‚®ä»¶æµ‹è¯•æˆåŠŸ'
msg['From'] = sender_email
msg['To'] = receiver_email

# å°è¯•å‘é€
try:
    # å°è¯•STARTTLS (ç«¯å£587) - æœ€å…¼å®¹
    server = smtplib.SMTP(smtp_server, 587)
    server.ehlo()
    server.starttls()
    server.ehlo()
    server.login(sender_email, password)
    server.send_message(msg)
    server.quit()
    print("âœ… é‚®ä»¶å‘é€æˆåŠŸ (STARTTLS)")
    sys.exit(0)
except Exception as e1:
    print(f"âš ï¸ STARTTLSå¤±è´¥: {str(e1)[:80]}")
    try:
        # å¤‡é€‰: SSL (ç«¯å£465)
        import ssl
        context = ssl.create_default_context()
        server = smtplib.SMTP_SSL(smtp_server, 465, context=context)
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        print("âœ… é‚®ä»¶å‘é€æˆåŠŸ (SSL)")
        sys.exit(0)
    except Exception as e2:
        print(f"âŒ SSLä¹Ÿå¤±è´¥: {str(e2)[:80]}")
        sys.exit(1)
EOF
          
          if [ $? -eq 0 ]; then
            echo "ğŸ‰ æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥ä½ çš„æ”¶ä»¶ç®±ã€‚"
          else
            echo "âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥Secretsé…ç½®ã€‚"
            echo "å¸¸è§é—®é¢˜ï¼š"
            echo "1. é‚®ç®±å¯†ç æ˜¯å¦æ­£ç¡®ï¼ˆGmailéœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç ï¼‰"
            echo "2. SMTPæœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®"
            echo "3. é‚®ç®±æ˜¯å¦å¼€å¯äº†SMTPæœåŠ¡"
          fi