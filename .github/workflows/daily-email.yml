name: 'Daily AI News Email Push'
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  test-smtp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 'Send test email'
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
          SENDER: ${{ secrets.SENDER_EMAIL }}
          RECEIVER: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "Starting email test..."
          
          # 写Python代码到文件
          python_code='
import os, smtplib, sys
from email.mime.text import MIMEText

server = os.environ.get("SMTP_SERVER")
sender = os.environ.get("SENDER")
password = os.environ.get("SMTP_PASS")
receiver = os.environ.get("RECEIVER")

print("SMTP Configuration:")
print(f"  Server: {server}")
print(f"  Sender: {sender}")
print(f"  Receiver: {receiver}")

if not all([server, sender, password, receiver]):
    print("Missing SMTP configuration in GitHub Secrets")
    sys.exit(0)

msg = MIMEText("这是AI新闻雷达的测试邮件", "plain", "utf-8")
msg["Subject"] = "✅ AI News Radar: Test Email"
msg["From"] = sender
msg["To"] = receiver

try:
    s = smtplib.SMTP(server, 587)
    s.starttls()
    s.login(sender, password)
    s.send_message(msg)
    s.quit()
    print("SUCCESS: Email sent")
    sys.exit(0)
except Exception as e:
    print(f"FAILED: {str(e)[:80]}")
    sys.exit(1)
          '
          
          # 写入临时文件执行
          echo "$python_code" > /tmp/test_email.py
          python3 /tmp/test_email.py