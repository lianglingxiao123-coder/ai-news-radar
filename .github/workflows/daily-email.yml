name: Daily AI News Email
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Test SMTP Connection
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "Testing email configuration..."
          
          # 直接使用heredoc写入Python文件
          cat > /tmp/test_email.py << 'PYEOF'
import os
import smtplib
import sys
from email.mime.text import MIMEText

# Get SMTP configuration
server = os.environ.get('SMTP_SERVER')
sender = os.environ.get('SENDER_EMAIL')
password = os.environ.get('SMTP_PASSWORD')
receiver = os.environ.get('RECEIVER_EMAIL')

print('SMTP Configuration Check:')
print(f'Server: {server}')
print(f'Sender: {sender}')
print(f'Receiver: {receiver}')

if not all([server, sender, password, receiver]):
    print('Missing SMTP configuration')
    sys.exit(0)

# Create email
msg = MIMEText('Test email from AI News Radar', 'plain', 'utf-8')
msg['Subject'] = 'AI News Radar Test'
msg['From'] = sender
msg['To'] = receiver

try:
    # Try connection
    conn = smtplib.SMTP(server, 587)
    conn.starttls()
    conn.login(sender, password)
    conn.send_message(msg)
    conn.quit()
    print('SUCCESS: Email sent')
    sys.exit(0)
except Exception as e:
    print(f'ERROR: {e}')
    sys.exit(1)
PYEOF
          
          # 执行Python脚本
          python3 /tmp/test_email.py
      
      - name: Report Result
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Email test successful!"
          else
            echo "⚠️ Email test failed"
          fi