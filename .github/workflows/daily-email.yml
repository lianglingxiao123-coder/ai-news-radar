name: AI News Daily Digest
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'  # UTC 23:30 = åŒ—äº¬ 07:30

jobs:
  send-daily-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œå¯èƒ½éœ€è¦å®Œæ•´ä»£ç 
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Debug - List files
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ğŸ“„ send_email.py è¯¦æƒ…:"
          if [ -f "send_email.py" ]; then
            ls -la send_email.py
          else
            echo "send_email.py ä¸å­˜åœ¨"
          fi
      
      - name: Install dependencies
        run: |
          echo "å®‰è£…ä¾èµ–..."
          python3 -m pip install --upgrade pip
          
          # åˆ†åˆ«å°è¯•ä¸åŒæ–¹å¼å®‰è£…
          if [ -f "requirements.txt" ]; then
            echo "ä» requirements.txt å®‰è£…"
            pip3 install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            echo "ä» pyproject.toml å®‰è£…"
            pip3 install -e .
          fi
          
          # é‚®ä»¶ç›¸å…³åŒ…
          pip3 install secure-smtplib python-dotenv
      
      - name: Run AI News Email Script
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "å¼€å§‹æ‰§è¡ŒAIæ–°é—»æ‘˜è¦..."
          echo "ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "SMTPæœåŠ¡å™¨: $SMTP_SERVER"
          echo "å‘ä»¶äºº: $SENDER_EMAIL"
          echo "æ”¶ä»¶äºº: $RECEIVER_EMAIL"
          
          # å®‰å…¨æ£€æŸ¥ï¼šå…ˆéªŒè¯é…ç½®
          if [ -z "$SMTP_SERVER" ] || [ -z "$SMTP_PASSWORD" ] || [ -z "$SENDER_EMAIL" ] || [ -z "$RECEIVER_EMAIL" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€çš„SMTPé…ç½®"
            echo "è¯·æ£€æŸ¥: SMTP_SERVER, SMTP_PASSWORD, SENDER_EMAIL, RECEIVER_EMAIL"
            exit 0
          fi
          
          # åˆ†é˜¶æ®µæ‰§è¡Œ
          if [ -f "send_email.py" ]; then
            echo "ğŸ“¦ æ‰¾åˆ° send_email.pyï¼Œå‡†å¤‡æ‰§è¡Œ..."
            echo "æ–‡ä»¶å¤§å°: $(wc -l < send_email.py) è¡Œ"
            
            # 1. æµ‹è¯•å¯¼å…¥
            echo "ğŸ”„ æµ‹è¯•Pythonå¯¼å…¥..."
            python3 -c "import smtplib, email; print('âœ… åŸºç¡€æ¨¡å—å¯¼å…¥æ­£å¸¸')"
            
            # 2. æ£€æŸ¥è„šæœ¬éœ€æ±‚
            echo "ğŸ” æ£€æŸ¥è„šæœ¬éœ€æ±‚..."
            if python3 -c "import importlib.util; spec = importlib.util.spec_from_file_location('send_email', 'send_email.py'); print('âœ… å¯ä»¥åŠ è½½ send_email')"; then
              echo "âœ… send_email.py å¯åŠ è½½"
            else:
              echo "âš ï¸ send_email.py å¯èƒ½æœ‰è¯­æ³•é—®é¢˜"
            
            # 3. æ‰§è¡Œè„šæœ¬å¹¶æ•è·é”™è¯¯
            echo "ğŸš€ æ‰§è¡Œ send_email.py..."
            set +e  # å…è®¸é”™è¯¯
            python3 send_email.py 2>&1
            result=$?
            set -e
            
            if [ $result -eq 0 ]; then
              echo "ğŸ‰ send_email.py æ‰§è¡ŒæˆåŠŸï¼"
              exit 0
            else
              echo "âš ï¸ send_email.py æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $result)"
              echo "å°è¯•å‘é€ç®€åŒ–ç‰ˆæœ¬..."
            fi
          else:
            echo "send_email.py ä¸å­˜åœ¨"
          fi
          
          # å¤‡ç”¨æ–¹æ¡ˆï¼šå‘é€ç®€å•é‚®ä»¶
          echo "ğŸ“§ å‘é€ç®€åŒ–é€šçŸ¥..."
          python3 -c "
import os, smtplib, datetime
from email.mime.text import MIMEText

smtp_server = os.getenv('SMTP_SERVER')
smtp_password = os.getenv('SMTP_PASSWORD')
sender = os.getenv('SENDER_EMAIL')
receiver = os.getenv('RECEIVER_EMAIL')

today = datetime.datetime.now().strftime('%Y-%m-%d')
subject = f'AI News Digest - {today}'
body = f'''AI News Radar ç³»ç»Ÿé€šçŸ¥

æ—¶é—´: {today} 07:30

çŠ¶æ€: ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
è¯´æ˜: é‚®ä»¶æ‘˜è¦æœåŠ¡å·²å¯åŠ¨

è¯¦ç»†ä¿¡æ¯:
- SMTPé…ç½®: æ­£å¸¸
- è°ƒåº¦æ—¶é—´: æ¯æ—¥07:30 (åŒ—äº¬)
- ç³»ç»ŸçŠ¶æ€: åœ¨çº¿

å¤‡æ³¨: å¦‚æœæœªæ”¶åˆ°å®Œæ•´æ–°é—»æ‘˜è¦ï¼Œè¯·æ£€æŸ¥ send_email.py è„šæœ¬

-- AI News Radar è‡ªåŠ¨ç³»ç»Ÿ
'''

print(f'ä¸»é¢˜: {subject}')
print(f'å‘ä»¶äºº: {sender}')
print(f'æ”¶ä»¶äºº: {receiver}')

try:
    msg = MIMEText(body, 'plain', 'utf-8')
    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = receiver
    
    with smtplib.SMTP(smtp_server, 587) as server:
        server.starttls()
        server.login(sender, smtp_password)
        server.send_message(msg)
        print('âœ… ç®€åŒ–é€šçŸ¥å‘é€æˆåŠŸ')
except Exception as e:
    print(f'âš ï¸ ç®€åŒ–é€šçŸ¥å‘é€å¤±è´¥: {e}')
"
          echo "ğŸ“¤ é‚®ä»¶å‘é€å®Œæˆ"
      
      - name: Completion Status
        run: |
          echo "âœ… AI Newsé‚®ä»¶æµç¨‹å®Œæˆ"
          echo "ä¸‹æ¬¡è¿è¡Œ: $(TZ='Asia/Shanghai' date -d '+1 day 07:30' '+%Y-%m-%d %H:%M') åŒ—äº¬æ—¶é—´"
          echo "ğŸ“Š ç³»ç»ŸçŠ¶æ€: åœ¨çº¿"