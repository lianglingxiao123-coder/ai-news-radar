name: Daily Email Push
on:
  workflow_dispatch:     # âœ… è¿™ä¸ªå¿…é¡»æœ‰ï¼Œæ‰èƒ½æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '30 23 * * *'  # UTC 23:30 (åŒ—äº¬7:30)

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install minimal packages
        run: |
          pip install requests beautifulsoup4 feedparser python-dateutil pytz
          
      - name: Create test data
        run: |
          mkdir -p data
          echo '{"test": "data"}' > data/test.json
          
      - name: Send Email Test
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        run: |
          echo "ğŸ“§ Email Test Starting..."
          echo "é…ç½®æ£€æŸ¥:"
          echo "SMTP_SERVER: ${{ secrets.SMTP_SERVER != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo "SENDER_EMAIL: ${{ secrets.SENDER_EMAIL != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo "RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          echo "å¯†ç é•¿åº¦: ${{ secrets.SMTP_PASSWORD && secrets.SMTP_PASSWORD.size() || 0 }} å­—ç¬¦"
          
          python3 << 'PYEND'
import os, smtplib, sys
from email.mime.text import MIMEText

smtp_server = os.environ.get('SMTP_SERVER')
sender = os.environ.get('SENDER_EMAIL')
password = os.environ.get('SMTP_PASSWORD')
receiver = os.environ.get('RECEIVER_EMAIL')
port = os.environ.get('SMTP_PORT', '587')

print(f"ğŸ¯ é‚®ä»¶é…ç½®:")
print(f"  æœåŠ¡å™¨: {smtp_server}")
print(f"  ç«¯å£: {port}")
print(f"  å‘ä»¶äºº: {sender}")
print(f"  æ”¶ä»¶äºº: {receiver}")
print(f"  å¯†ç : {'å·²è®¾ç½®' if password else 'æœªè®¾ç½®'}")

if not all([smtp_server, sender, password, receiver]):
    print("âŒ é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶å‘é€")
    sys.exit(0)

# å‘é€æµ‹è¯•é‚®ä»¶
msg = MIMEText("æµ‹è¯•é‚®ä»¶ï¼šä½ çš„AIæ–°é—»é›·è¾¾æ¯æ—¥æ¨é€ç³»ç»Ÿå·²ä¿®å¤ã€‚æ˜æ—¥å¼€å§‹7:30è‡ªåŠ¨æ¨é€åŒ…å«Twitter/YouTube/RSSçš„AIæ–°é—»ã€‚", 'plain', 'utf-8')
msg['Subject'] = 'âœ… AIæ–°é—»é›·è¾¾ï¼šç³»ç»Ÿä¿®å¤éªŒè¯'
msg['From'] = sender
msg['To'] = receiver

try:
    server = smtplib.SMTP(smtp_server, int(port))
    server.starttls()
    server.login(sender, password)
    server.send_message(msg)
    server.quit()
    print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼è¯·åœ¨1åˆ†é’Ÿå†…æ£€æŸ¥é‚®ç®±ã€‚")
    sys.exit(0)
    
except Exception as e:
    error_msg = str(e)
    print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {error_msg}")
    
    # å°è¯•å…¶ä»–ç«¯å£
    ports = [587, 465, 25]
    for alt_port in ports:
        if str(alt_port) == port: continue
        try:
            print(f"å°è¯•ç«¯å£ {alt_port}...")
            if alt_port == 465:
                import ssl
                context = ssl.create_default_context()
                server = smtplib.SMTP_SSL(smtp_server, alt_port, context=context)
            else:
                server = smtplib.SMTP(smtp_server, alt_port)
                if alt_port == 587:
                    server.starttls()
            
            server.login(sender, password)
            server.send_message(msg)
            server.quit()
            print(f"âœ… ç«¯å£ {alt_port} æˆåŠŸå‘é€ï¼")
            sys.exit(0)
        except Exception as e2:
            print(f"ç«¯å£ {alt_port} å¤±è´¥: {str(e2)[:60]}")
    
    sys.exit(1)
PYEND
      
      - name: Report
        if: always()
        run: |
          echo "========================================"
          echo "AIæ–°é—»é›·è¾¾ - é‚®ç®±ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š"
          echo "========================================"
          echo "æ—¶é—´: $(date)"
          echo "ç»“æœ: $( [ $? -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥' )"
          echo ""
          echo "å¦‚æœçœ‹åˆ°'é‚®ä»¶å‘é€æˆåŠŸ'ï¼Œè¯·åœ¨é‚®ç®±ä¸­ç¡®è®¤ã€‚"
          echo "ğŸ“… ç³»ç»Ÿå°†ä»æ˜æ—¥èµ·æ¯æ—¥7:30è‡ªåŠ¨æ¨é€ã€‚"
