name: AI News Daily Digest
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'  # UTC 23:30 = 北京 07:30

jobs:
  send-daily-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip3 install -r requirements.txt
          fi
          # 确保有SMTP库
          pip3 install --upgrade setuptools
      
      - name: Run AI News Email Script
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          # 从新闻更新脚本中获取的变量
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN || '' }}
        run: |
          echo "Starting AI News daily digest generation..."
          echo "SMTP server: $SMTP_SERVER"
          echo "Sender: $SENDER_EMAIL"
          echo "Receiver: $RECEIVER_EMAIL"
          
          # 检查send_email.py是否存在
          if [ -f "send_email.py" ]; then
            echo "✅ Found send_email.py"
            python3 send_email.py
          else
            echo "❌ send_email.py not found, creating basic fallback"
            # 如果send_email.py不存在，先创建一个
            cat > /tmp/fallback_email.py << 'ENDPY'
import os, smtplib, datetime
from email.mime.text import MIMEText

# 从环境变量获取配置
smtp_server = os.getenv("SMTP_SERVER", "")
smtp_password = os.getenv("SMTP_PASSWORD", "")
sender = os.getenv("SENDER_EMAIL", "")
receiver = os.getenv("RECEIVER_EMAIL", "")

# 基本验证
if not all([smtp_server, smtp_password, sender, receiver]):
    print("Missing required SMTP configuration")
    exit(0)

# 创建邮件
today = datetime.datetime.now().strftime("%Y-%m-%d")
subject = f"AI News Digest - {today}"
body = f"""
AI News Daily Summary - {today}

[含 AI 新闻 - AI News] Summary

Due to a script error, the full news digest could not be generated.

Please check:
1. send_email.py script
2. News data sources
3. SMTP configuration

The system will retry in the next cycle.

-- AI News Radar System
"""

msg = MIMEText(body, 'plain', 'utf-8')
msg['Subject'] = subject
msg['From'] = sender
msg['To'] = receiver

# 发送邮件
try:
    with smtplib.SMTP(smtp_server, 587) as server:
        server.starttls()
        server.login(sender, smtp_password)
        server.send_message(msg)
        print("✅ Fallback email sent successfully")
        exit(0)
except Exception as e:
    print(f"❌ Email sending failed: {e}")
    exit(1)
ENDPY
            python3 /tmp/fallback_email.py
          fi
      
      - name: Completion Status
        run: |
          echo "✅ AI News email workflow completed"
          echo "Next scheduled run: $(TZ='Asia/Shanghai' date -d '+1 day 07:30' '+%Y-%m-%d %H:%M') Beijing time"