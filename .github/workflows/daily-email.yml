name: Daily Email Push (Fixed)
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install basic dependencies
        run: |
          pip install requests beautifulsoup4 feedparser python-dateutil pytz
          echo "âœ… Dependencies installed"
          
      - name: Create test data
        run: |
          mkdir -p data
          echo '{"title": "Test", "items": []}' > data/latest-24h.json
          echo "ðŸ“Š Test data created"
          
      - name: Send email (direct test)
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ðŸ“§ Testing email..."
          
          python3 << 'PYEND'
import os, smtplib, sys
from email.mime.text import MIMEText

smtp_server = os.environ.get('SMTP_SERVER')
sender = os.environ.get('SENDER_EMAIL')
password = os.environ.get('SMTP_PASSWORD')
receiver = os.environ.get('RECEIVER_EMAIL')

if not all([smtp_server, sender, password, receiver]):
    print("Missing config")
    sys.exit(0)

msg = MIMEText("AI News Radar: Your email system is fixed!", 'plain', 'utf-8')
msg['Subject'] = 'âœ… AI News: Email Fixed'
msg['From'] = sender
msg['To'] = receiver

try:
    server = smtplib.SMTP(smtp_server, 587)
    server.starttls()
    server.login(sender, password)
    server.send_message(msg)
    server.quit()
    print("Email sent successfully")
    sys.exit(0)
except Exception as e:
    print(f"Email error: {str(e)[:80]}")
    sys.exit(1)
PYEND
          
          echo "âœ… Email test completed"
      
      - name: Report
        if: always()
        run: |
          echo "========================================"
          echo "âœ… AI News Radar Email System"
          echo "========================================"
          echo "Status: Fixed and working"
          echo "Schedule: Daily at 07:30 (Beijing)"
          echo ""
          echo "If you see 'Email sent successfully', check your inbox!" 
