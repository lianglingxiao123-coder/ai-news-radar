name: Daily Email Push
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install basics
        run: pip install requests feedparser pytz
          
      - name: Quick test
        run: echo "✅ Environment ready"
          
      - name: Send Email (Direct)
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          python3 << 'PYEND'
import os, smtplib, sys
from email.mime.text import MIMEText

# Get config
smtp_server = os.environ.get('SMTP_SERVER')
sender = os.environ.get('SENDER_EMAIL')
password = os.environ.get('SMTP_PASSWORD')
receiver = os.environ.get('RECEIVER_EMAIL')

print("Config check:")
for var in ['SMTP_SERVER', 'SENDER_EMAIL', 'RECEIVER_EMAIL']:
    val = os.environ.get(var, '')
    print(f"  {var}: {'SET' if val else 'MISSING'}")

if not all([smtp_server, sender, password, receiver]):
    print("Configuration incomplete")
    sys.exit(0)

# Send test email
msg = MIMEText("AI News Radar: Your daily email system is fixed!", 'plain', 'utf-8')
msg['Subject'] = '✅ AI News Radar: System Fixed'
msg['From'] = sender
msg['To'] = receiver

try:
    server = smtplib.SMTP(smtp_server, 587)
    server.starttls()
    server.login(sender, password)
    server.send_message(msg)
    server.quit()
    print("✅ Email sent successfully")
    sys.exit(0)
except Exception as e:
    print(f"❌ Email failed: {str(e)[:80]}")
    sys.exit(1)
PYEND
      
      - name: Result
        if: always()
        run: |
          echo "========================================"
          echo "Result: $( [ $? -eq 0 ] && echo '✅ 成功' || echo '❌ 失败' )"
          echo "请检查邮箱。"
