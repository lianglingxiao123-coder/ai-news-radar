name: Daily AI News Email
on:
  workflow_dispatch:
  schedule:
    - cron: '30 23 * * *'

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Test SMTP Connection
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "Testing email configuration..."
          
          # 创建Python测试脚本
          python_code='
import os, smtplib, sys
from email.mime.text import MIMEText

s = os.environ.get("SMTP_SERVER")
f = os.environ.get("SENDER_EMAIL")
p = os.environ.get("SMTP_PASSWORD")
r = os.environ.get("RECEIVER_EMAIL")

print("SMTP Configuration Check:")
print("Server:", s)
print("Sender:", f)
print("Receiver:", r)

if not all([s, f, p, r]):
    print("Configuration incomplete.")
    sys.exit(0)

msg = MIMEText("Test email from AI News Radar system", "plain", "utf-8")
msg["Subject"] = "AI News Radar Test"
msg["From"] = f
msg["To"] = r

try:
    conn = smtplib.SMTP(s, 587)
    conn.starttls()
    conn.login(f, p)
    conn.send_message(msg)
    conn.quit()
    print("SUCCESS: Email sent successfully")
    sys.exit(0)
except Exception as e:
    print("ERROR:", str(e))
    sys.exit(1)
          '
          
          # 写入文件执行
          echo "$python_code" > /tmp/email_test.py
          python3 /tmp/email_test.py
      
      - name: Report Result
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Email test successful!"
          else
            echo "⚠️ Email test failed - check SMTP configuration"
          fi