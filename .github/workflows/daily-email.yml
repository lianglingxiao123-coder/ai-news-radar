name: Daily Email Push
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:00
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  send-email:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # ä½¿ç”¨è¾ƒæ–°çš„ Python ç‰ˆæœ¬
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || echo "requirements.txtå®‰è£…å¤±è´¥ï¼Œç»§ç»­"
      
      # å…ˆæµ‹è¯• SMTP è¿æ¥ï¼Œä¸æˆåŠŸå°±æå‰é€€å‡º
      - name: Test SMTP connectivity
        id: test_smtp
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ§ª æµ‹è¯•SMTPè¿æ¥æ€§..."
          
          test_script=$(cat << 'EOF'
import os, smtplib, ssl
import sys

smtp_server = os.environ.get('SMTP_SERVER')
sender_email = os.environ.get('SENDER_EMAIL')
smtp_password = os.environ.get('SMTP_PASSWORD')

if not all([smtp_server, sender_email, smtp_password]):
    print("âŒ ç¼ºå°‘å¿…è¦çš„SMTPé…ç½®")
    sys.exit(1)

print(f"æµ‹è¯•è¿æ¥: {smtp_server}")

success = False
methods = [
    (587, 'STARTTLS'),
    (465, 'SSL'),
]

for port, method in methods:
    try:
        print(f"å°è¯•ç«¯å£ {port} ({method})...")
        if method == 'SSL':
            context = ssl.create_default_context()
            with smtplib.SMTP_SSL(smtp_server, port, context=context, timeout=10) as server:
                server.noop()  # ç®€å•æµ‹è¯•è¿æ¥
        else:
            with smtplib.SMTP(smtp_server, port, timeout=10) as server:
                server.ehlo()
                server.noop()
        print(f"âœ… ç«¯å£ {port} å¯ç”¨")
        success = True
        break
    except Exception as e:
        if "connection refused" in str(e).lower() or "timed out" in str(e).lower():
            print(f"âš ï¸ ç«¯å£ {port} ä¸å¯ç”¨: {str(e)[:50]}")
        else:
            print(f"âš ï¸ ç«¯å£ {port} é”™è¯¯: {str(e)[:50]}")
            success = True  # è¿æ¥å»ºç«‹ä½†æœ‰å…¶ä»–é”™è¯¯ä¹Ÿç®—é€šè¿‡

print("\n" + ("âœ… SMTPè¿æ¥å¯ç”¨" if success else "âŒ SMTPè¿æ¥æµ‹è¯•å¤±è´¥"))
sys.exit(0 if success else 1)
EOF
          )
          
          python3 -c "$test_script"
          
          if [ $? -eq 0 ]; then
            echo "smtp_test=passed" >> $GITHUB_OUTPUT
          else:
            echo "smtp_test=failed" >> $GITHUB_OUTPUT
      
      # å¦‚æœ SMTP æµ‹è¯•å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨é‚®ä»¶æœåŠ¡
      - name: Setup fallback email service
        if: steps.test_smtp.outputs.smtp_test == 'failed'
        run: |
          echo "âš ï¸ SMTPç›´è¿å¤±è´¥ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ..."
          echo "åå¤‡æ–¹æ¡ˆ: SendGrid/Resend API æˆ–æœ¬åœ°é€šçŸ¥"
          
          # ç®€åŒ–ç‰ˆæœ¬ï¼šä½¿ç”¨GitHub APIåˆ›å»ºIssueä½œä¸ºé€šçŸ¥
          echo "å°†åˆ›å»ºGitHub Issueä½œä¸ºé‚®ä»¶æ›¿ä»£"
      
      - name: Load and fetch news
        id: fetch_news
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          # åŠ è½½OPMLé…ç½®
          if [ ! -z "$OPML_B64" ]; then
            echo "åŠ è½½ç§æœ‰OPMLé…ç½®..."
            mkdir -p feeds
            echo "$OPML_B64" | base64 --decode > feeds/follow.opml 2>/dev/null
          fi
          
          # ä½¿ç”¨ç®€åŒ–æŠ“å–ï¼Œé™ä½å¤±è´¥ç‡
          echo "å¼€å§‹æ–°é—»æŠ“å–..."
          python scripts/update_news.py \
            --output-dir data \
            --window-hours 24 \
            --silent \
            --timeout 300 || echo "æŠ“å–å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          
          # ç”Ÿæˆæ›´ç®€å•çš„é‚®ä»¶å†…å®¹
          echo "ç”Ÿæˆé‚®ä»¶é¢„è§ˆ..."
          if [ -f data/latest-24h.json ]; then
            ITEM_COUNT=$(python3 -c "import json; data=json.load(open('data/latest-24h.json')); print(data.get('total_items', 0))")
            echo "item_count=$ITEM_COUNT" >> $GITHUB_OUTPUT
          fi
      
      # å…¼å®¹æ€§é‚®ä»¶å‘é€
      - name: Send universal email
        id: send_compatible_email
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ“§ å…¼å®¹æ€§é‚®ä»¶å‘é€..."
          
          # ç›®çš„åœ°ä¹Ÿæµ‹è¯•å…¼å®¹è„šæœ¬
          cp /tmp/compatible-email.py scripts/send_email.py
          
          # è¿è¡Œå‘é€
          if python3 scripts/send_email.py; then
            echo "email_status=success" >> $GITHUB_OUTPUT
            echo "âœ… é‚®ä»¶å‘é€æˆåŠŸ"
          else
            echo "email_status=failed" >> $GITHUB_OUTPUT
            echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
            
            # æ›¿ä»£æ–¹æ¡ˆï¼šåˆ›å»ºGitHub Issueé€šçŸ¥
            echo "åˆ›å»ºGitHub Issueä½œä¸ºæ›¿ä»£é€šçŸ¥..."
            
            # ç®€åŒ–ç‰ˆæœ¬ï¼šç›´æ¥è¾“å‡ºåˆ°æ—¥å¿—
            echo "ğŸ“‹ æ¯æ—¥æ–°é—»æ‘˜è¦ï¼ˆåœ¨æ­¤å¤„æ›¿ä»£é‚®ä»¶ï¼‰"
            echo "======================================"
            if [ -f data/latest-24h.json ]; then
              python3 -c "
import json
try:
    with open('data/latest-24h.json', 'r') as f:
        data = json.load(f)
    items = data.get('items', [data])[:10]
    for i, item in enumerate(items):
        if isinstance(item, dict):
            title = item.get('title', 'æ— æ ‡é¢˜')
            link = item.get('url', item.get('link', '#'))
            source = item.get('source_name', item.get('site_name', ''))
            print(f'{i+1}. {title[:80]}...')
            print(f'   æ¥æº: {source}, é“¾æ¥: {link[:60]}...')
except:
    print('æ— æ³•è§£ææ•°æ®æ–‡ä»¶')
              "
            else:
              echo "æ— å¯ç”¨æ•°æ®"
          fi
      
      # æ¸…ç†å’Œé€šçŸ¥
      - name: Final summary
        run: |
          echo "ğŸ“Š å·¥ä½œæµæ‰§è¡Œæ€»ç»“:"
          echo "- SMTPæµ‹è¯•: ${{ steps.test_smtp.outputs.smtp_test }}"
          echo "- æ–°é—»æ¡æ•°: ${{ steps.fetch_news.outputs.item_count || 0 }}"
          echo "- é‚®ä»¶çŠ¶æ€: ${{ steps.send_compatible_email.outputs.email_status || 'unknown' }}"
          
          if [[ "${{ steps.send_compatible_email.outputs.email_status }}" == "success" ]]; then
            echo "ğŸ‰ é‚®ä»¶å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼ä½ åº”è¯¥å¾ˆå¿«ä¼šæ”¶åˆ°é‚®ä»¶ã€‚"
          else
            echo "âš ï¸ é‚®ä»¶å‘é€å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥GitHub Secretsé…ç½®ã€‚"
            echo "è¯·è®¿é—® https://github.com/ ${{ github.repository }}/settings/secrets/actions"
            echo "é…ç½®: SMTP_SERVER, SENDER_EMAIL, SMTP_PASSWORD, RECEIVER_EMAIL"
          fi