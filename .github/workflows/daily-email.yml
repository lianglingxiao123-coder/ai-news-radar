name: Daily Email Push
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:00
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install
        run: pip install -r requirements.txt
      
      - name: Load OPML
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          if [ -n "$OPML_B64" ]; then
            mkdir -p feeds
            echo "$OPML_B64" | base64 --decode > feeds/follow.opml 2>/dev/null || true
          fi
      
      - name: Fetch news
        run: |
          if [ -f feeds/follow.opml ]; then
            python scripts/update_news.py --output-dir data --window-hours 24 --rss-opml feeds/follow.opml --timeout 90
          else
            python scripts/update_news.py --output-dir data --window-hours 24 --timeout 90
          fi
      
      - name: Send email (Fallback method)
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ“§ ä½¿ç”¨å¤‡é€‰æ–¹æ³•å‘é€é‚®ä»¶"
          
          # åˆ›å»ºå¯é çš„é‚®ä»¶å‘é€è„šæœ¬
          cat > /tmp/send_simple.py << 'EOF'
import os, smtplib, ssl, json, time, sys
from email.mime.text import MIMEText

def send_test_email():
    smtp_server = os.getenv('SMTP_SERVER', '').strip()
    sender_email = os.getenv('SENDER_EMAIL', '').strip()
    password = os.getenv('SMTP_PASSWORD', '').strip()
    receiver_email = os.getenv('RECEIVER_EMAIL', '').strip()
    
    if not all([smtp_server, sender_email, password, receiver_email]):
        print("âŒ ç¼ºå°‘SMTPé…ç½®")
        return False
    
    print(f"ä½¿ç”¨æœåŠ¡å™¨: {smtp_server}")
    print(f"å‘ä»¶äºº: {sender_email}")
    print(f"æ”¶ä»¶äºº: {receiver_email}")
    
    # åˆ›å»ºé‚®ä»¶
    html_content = '''
    <h2>ğŸ¤– AIæ–°é—»é›·è¾¾</h2>
    <p>æµ‹è¯•é‚®ä»¶ - å¦‚æœä½ æ”¶åˆ°è¿™å°é‚®ä»¶ï¼Œè¯´æ˜ç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼</p>
    <p>è¯·æ£€æŸ¥ä½ çš„æ”¶ä»¶ç®±æˆ–åƒåœ¾ç®±ã€‚</p>
    '''
    
    msg = MIMEText(html_content, 'html', 'utf-8')
    msg['Subject'] = 'âœ… AIæ–°é—»é›·è¾¾æµ‹è¯•é‚®ä»¶'
    msg['From'] = sender_email
    msg['To'] = receiver_email
    
    # æ–¹æ³•1: ç®€å•SMTP (æœ€å¸¸è§)
    try:
        print("å°è¯•æ–¹æ³•1: STARTTLS (587)")
        server = smtplib.SMTP(smtp_server, 587, timeout=15)
        server.ehlo()
        server.starttls()
        server.ehlo()
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        print("âœ… Method 1 æˆåŠŸ")
        return True
    except Exception as e:
        print(f"æ–¹æ³•1å¤±è´¥: {str(e)[:50]}")
    
    # æ–¹æ³•2: SSL (465)
    try:
        print("å°è¯•æ–¹æ³•2: SSL (465)")
        context = ssl.create_default_context()
        server = smtplib.SMTP_SSL(smtp_server, 465, context=context, timeout=15)
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        print("âœ… Method 2 æˆåŠŸ")
        return True
    except Exception as e:
        print(f"æ–¹æ³•2å¤±è´¥: {str(e)[:50]}")
    
    # æ–¹æ³•3: æ— TLS (ä¸æ¨èï¼Œä½†æµ‹è¯•ç”¨)
    try:
        print("å°è¯•æ–¹æ³•3: No TLS (25)")
        server = smtplib.SMTP(smtp_server, 25, timeout=15)
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        print("âœ… Method 3 æˆåŠŸ")
        return True
    except Exception as e:
        print(f"æ–¹æ³•3å¤±è´¥: {str(e)[:50]}")
    
    return False

if __name__ == "__main__":
    if send_test_email():
        print("ğŸ‰ é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ã€‚")
        sys.exit(0)
    else:
        print("âŒ æ‰€æœ‰å‘é€æ–¹å¼å¤±è´¥")
        sys.exit(1)
EOF
          
          python /tmp/send_simple.py
          
          if [ $? -eq 0 ]; then
            echo "âœ… é‚®ä»¶å·²å‘é€"
          else
            echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
          fi