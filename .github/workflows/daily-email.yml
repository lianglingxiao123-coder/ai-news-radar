name: Daily Email Push
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:00
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  send-email:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # åŠ è½½OPMLé…ç½®
      - name: Load OPML configuration
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          if [ ! -z "$OPML_B64" ]; then
            echo "åŠ è½½ç§æœ‰OPMLé…ç½®..."
            mkdir -p feeds
            echo "$OPML_B64" | base64 --decode > feeds/follow.opml 2>/dev/null || echo "OPMLè§£ç å¤±è´¥"
          fi
      
      # æŠ“å–æ–°é—»
      - name: Fetch latest news
        run: |
          if [ -f feeds/follow.opml ]; then
            python scripts/update_news.py \
              --output-dir data \
              --window-hours 24 \
              --rss-opml feeds/follow.opml \
              --timeout 300
          else
            python scripts/update_news.py \
              --output-dir data \
              --window-hours 24 \
              --timeout 300
          fi
      
      # å‘é€é‚®ä»¶ï¼ˆç®€åŒ–ä½†å¯é ï¼‰
      - name: Send email (simplified)
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "ğŸ“§ é‚®ä»¶å‘é€å¼€å§‹..."
          
          # åˆ›å»ºç®€å•çš„HTMLé‚®ä»¶å†…å®¹
          cat > send_email_simple.py << 'EOF'
import os, smtplib, ssl, json, sys
from email.mime.text import MIMEText
from datetime import datetime

def create_html():
    try:
        with open('data/latest-24h.json', 'r') as f:
            data = json.load(f)
        items = data.get('items', [])
        
        html = '<h2>ğŸ¤– AIæ–°é—»æ—¥æŠ¥</h2>'
        html += f'<p>ç”Ÿæˆæ—¶é—´: {datetime.now().strftime("%Y-%m-%d %H:%M")}</p>'
        
        # æ·»åŠ å‰15æ¡æ–°é—»
        for i, item in enumerate(items[:15]):
            if isinstance(item, dict):
                title = item.get('title', 'æ— æ ‡é¢˜')
                link = item.get('url', item.get('link', '#'))
                source = item.get('source_name', item.get('site_name', 'æœªçŸ¥æ¥æº'))
                html += f'<p><a href="{link}">{i+1}. {title[:80]}</a><br><small>æ¥æº: {source}</small></p>'
        
        html += '<hr><p style="color:gray">Powered by AI News Radar</p>'
        return html
    except:
        return "<h2>AIæ–°é—»æ—¥æŠ¥</h2><p>ä»Šæ—¥æ— æ•°æ®</p>"

def main():
    smtp_server = os.getenv('SMTP_SERVER')
    smtp_port = int(os.getenv('SMTP_PORT', '587'))
    sender_email = os.getenv('SENDER_EMAIL')
    smtp_password = os.getenv('SMTP_PASSWORD')
    receiver_email = os.getenv('RECEIVER_EMAIL')
    
    if not all([smtp_server, sender_email, smtp_password, receiver_email]):
        print("âŒ ç¼ºå°‘SMTPé…ç½®ï¼Œè¯·æ£€æŸ¥GitHub Secrets")
        return False
    
    msg = MIMEText(create_html(), 'html', 'utf-8')
    msg['Subject'] = f'AIæ—¥æŠ¥ {datetime.now().strftime("%m/%d")}'
    msg['From'] = sender_email
    msg['To'] = receiver_email
    
    try:
        # å°è¯•STARTTLS
        server = smtplib.SMTP(smtp_server, smtp_port)
        server.starttls()
        server.login(sender_email, smtp_password)
        server.send_message(msg)
        server.quit()
        print("âœ… é‚®ä»¶å‘é€æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âš ï¸ STARTTLSå¤±è´¥: {str(e)[:50]}")
        try:
            # å¤‡é€‰: SSL
            context = ssl.create_default_context()
            server = smtplib.SMTP_SSL(smtp_server, 465, context=context)
            server.login(sender_email, smtp_password)
            server.send_message(msg)
            server.quit()
            print("âœ… é‚®ä»¶å‘é€æˆåŠŸ (SSL)")
            return True
        except Exception as e2:
            print(f"âŒ æ‰€æœ‰æ–¹å¼å¤±è´¥: {str(e2)[:50]}")
            return False

if __name__ == "__main__":
    if main():
        sys.exit(0)
    else:
        sys.exit(1)
EOF
          
          python send_email_simple.py
      
      - name: Notify on success
        if: success()
        run: |
          echo "ğŸ‰ é‚®ä»¶å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
          echo "å¦‚æœé‚®ä»¶æœªæ”¶åˆ°ï¼Œè¯·æ£€æŸ¥:"
          echo "1. GitHub Secretsé…ç½® (SMTP_SERVER, SENDER_EMAIL, SMTP_PASSWORD, RECEIVER_EMAIL)"
          echo "2. é‚®ä»¶å¯èƒ½è¿›å…¥äº†åƒåœ¾ç®±"
          echo "3. ç½‘ç»œå»¶è¿Ÿï¼Œç¨ç­‰ç‰‡åˆ»"
      
      - name: Log on failure
        if: failure()
        run: |
          echo "âš ï¸ é‚®ä»¶å‘é€å¤±è´¥"
          echo "å¸¸è§åŸå› :"
          echo "1. GitHub Secretsæœªé…ç½®"
          echo "2. SMTPæœåŠ¡å™¨è¿æ¥è¢«å±è”½"
          echo "3. é‚®ç®±æˆæƒå¯†ç é”™è¯¯"
          echo ""
          echo "è¯·é…ç½®ä»¥ä¸‹Secrets:"
          echo "SMTP_SERVER, SENDER_EMAIL, SMTP_PASSWORD, RECEIVER_EMAIL"