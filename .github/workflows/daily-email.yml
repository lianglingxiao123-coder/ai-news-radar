name: Daily Email Push
on:
  schedule:
    - cron: '0 23 * * *'  # UTC 23:00ï¼ŒåŒ—äº¬æ—¶é—´æ—©7:00ï¼Œæ›´å¯é 
    - cron: '30 23 * * *' # åŠå°æ—¶åé‡è¯•ï¼Œä½œä¸ºå¤‡ä»½
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  send-email:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # æ·»åŠ è¶…æ—¶é™åˆ¶
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      # æ£€æŸ¥æ˜¯å¦æœ‰ç§äººè®¢é˜…æ¸…å•
      - name: Load private subscription list
        id: load_opml
        env:
          OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          if [ ! -z "$OPML_B64" ]; then
            mkdir -p feeds
            echo "$OPML_B64" | base64 --decode > feeds/follow.opml
            echo "âœ… Loaded private OPML from secrets"
            echo "has_opml=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No OPML secret found, using default sources"
            echo "has_opml=false" >> $GITHUB_OUTPUT
          fi
      
      # æ›´æ–°æ–°é—»æ•°æ® - ä½¿ç”¨é›†ç¾¤OPMLè¿›è¡Œæ›´å¼ºå£®çš„æŠ“å–
      - name: Update latest news
        id: fetch_news
        run: |
          # å¦‚æœæœ‰é›†ç¾¤OPMLå°±ç”¨é›†ç¾¤ç‰ˆæœ¬
          if [ -f feeds/follow.opml ]; then
            echo "ä½¿ç”¨é›†ç¾¤OPMLè¿›è¡ŒæŠ“å–..."
            python scripts/update_news.py \
              --output-dir data \
              --window-hours 24 \
              --rss-opml feeds/follow.opml \
              --timeout 300 \
              --retry 2
          else
            echo "ä½¿ç”¨é»˜è®¤é…ç½®è¿›è¡ŒæŠ“å–..."
            python scripts/update_news.py \
              --output-dir data \
              --window-hours 24 \
              --timeout 300 \
              --retry 2
          fi
          
          # æ£€æŸ¥æŠ“å–ç»“æœ
          if [ -f data/latest-24h.json ]; then
            ITEM_COUNT=$(python -c "import json; data=json.load(open('data/latest-24h.json')); print(data.get('total_items', 0))")
            echo "item_count=$ITEM_COUNT" >> $GITHUB_OUTPUT
            echo "fetch_status=success" >> $GITHUB_OUTPUT
          else
            echo "fetch_status=failed" >> $GITHUB_OUTPUT
          fi
      
      # å¦‚æœæŠ“å–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
      - name: Use backup if needed
        if: steps.fetch_news.outputs.fetch_status == 'failed'
        run: |
          echo "âš ï¸ ä¸»è¦æŠ“å–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ç­–ç•¥..."
          # å°è¯•ç®€å•æŠ“å–
          python scripts/update_news.py \
            --output-dir data \
            --window-hours 24 \
            --min-items 10 || true
          
          # å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¤åˆ¶ç¤ºä¾‹æ•°æ®
          if [ ! -f data/latest-24h.json ]; then
            echo "ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºå¤‡ä»½..."
            cp data/sample-news.json data/latest-24h.json 2>/dev/null || true
          fi
      
      # ä½¿ç”¨æ”¹è¿›çš„é‚®ä»¶è„šæœ¬
      - name: Run improved email script
        id: send_email
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          # æ›¿æ¢é‚®ä»¶è„šæœ¬ä¸ºæ”¹è¿›ç‰ˆæœ¬
          cp /tmp/fixed-email-script.py scripts/send_email.py 2>/dev/null || echo "ä½¿ç”¨ç°æœ‰é‚®ä»¶è„šæœ¬"
          
          # å‘é€é‚®ä»¶
          python scripts/send_email.py
          
          if [ $? -eq 0 ]; then
            echo "email_status=success" >> $GITHUB_OUTPUT
          else
            echo "email_status=failed" >> $GITHUB_OUTPUT
          fi
      
      # å‘é€è¿è¡ŒçŠ¶æ€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Daily email push failed',
              body: `The daily email push workflow failed at ${new Date().toISOString()}.\n\nPlease check the workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            })

      - name: Success summary
        if: success()
        run: |
          echo "ğŸ‰ é‚®ä»¶æ¨é€å®Œæˆï¼"
          echo "æŠ“å–æ–°é—»æ•°: ${{ steps.fetch_news.outputs.item_count }}"
          echo "å‘é€æ—¶é—´: $(date)"